# 类型系统定义 DSL
# 定义电力系统资源的类型系统，包括类型、属性、关系、能力和操作

version: "0.1.0"
description: "电力系统资源类型系统定义"

# 基础类型定义
base_types:
  - name: IdentifiedObject
    attributes:
      - name: mRID
        type: string
        required: true
        key: true
        description: "模型资源标识符"
      - name: name
        type: string
        required: false
        description: "名称"
      - name: description
        type: string
        required: false
        description: "描述"

# 资源类型定义
resource_types:
  - name: PowerSystemResource
    base_type: IdentifiedObject
    attributes:
      - name: energyIdentCodeEic
        type: string
        required: false
        description: "能源标识码"
      - name: shortName
        type: string
        required: false
        description: "短名称"
    relationships:
      - name: contains
        target_type: PowerSystemResource
        cardinality: one_to_many
        inverse: partOf
        description: "包含关系"
      - name: partOf
        target_type: PowerSystemResource
        cardinality: many_to_one
        inverse: contains
        description: "属于关系"
      - name: operatedBy
        target_type: Organisation
        cardinality: many_to_one
        description: "运营关系"
    capabilities:
      - name: Control
        operations: [execute, query, cancel]
        description: "控制能力"
      - name: Measurement
        operations: [subscribe, read, unsubscribe]
        description: "测量能力"
    lifecycle:
      states: [created, active, inactive, deleted]
      transitions:
        - from: created
          to: active
          trigger: activate
        - from: active
          to: inactive
          trigger: deactivate
        - from: inactive
          to: active
          trigger: reactivate
        - from: active
          to: deleted
          trigger: delete
    access_control:
      default_permissions: [read, execute]
      required_roles: [operator, engineer]

  - name: EquipmentContainer
    base_type: PowerSystemResource
    attributes: []
    relationships:
      - name: contains
        target_type: PowerSystemResource
        cardinality: one_to_many
        inverse: partOf

  - name: Substation
    base_type: PowerSystemResource
    attributes:
      - name: region
        type: string
        required: false
        description: "区域"
    relationships:
      - name: contains
        target_type: VoltageLevel
        cardinality: one_to_many
        inverse: partOf
      - name: operatedBy
        target_type: Organisation
        cardinality: many_to_one

  - name: VoltageLevel
    base_type: EquipmentContainer
    attributes:
      - name: nominalVoltage
        type: float
        required: false
        description: "标称电压"
    relationships:
      - name: contains
        target_type: Bay
        cardinality: one_to_many
        inverse: partOf
      - name: partOf
        target_type: Substation
        cardinality: many_to_one
        inverse: contains

  - name: Breaker
    base_type: PowerSystemResource
    attributes:
      - name: ratedCurrent
        type: float
        required: false
        description: "额定电流"
      - name: normalOpen
        type: bool
        required: false
        description: "正常开状态"
    capabilities:
      - name: SwitchControl
        operations: [open, close, queryState]
        description: "开关控制能力"
      - name: Control
        operations: [execute, query, cancel]
      - name: Measurement
        operations: [subscribe, read, unsubscribe]

  - name: PowerTransformer
    base_type: PowerSystemResource
    attributes:
      - name: constructionKind
        type: string
        required: false
        description: "构造类型"
    relationships:
      - name: hasEnd
        target_type: TransformerEnd
        cardinality: one_to_many
      - name: locatedIn
        target_type: Substation
        cardinality: many_to_one
    capabilities:
      - name: Control
        operations: [execute, query, cancel]
      - name: Measurement
        operations: [subscribe, read, unsubscribe]

  - name: SynchronousMachine
    base_type: PowerSystemResource
    attributes:
      - name: ratedPower
        type: float
        required: false
        description: "额定功率"
      - name: ratedVoltage
        type: float
        required: false
        description: "额定电压"
    capabilities:
      - name: Control
        operations: [execute, query, cancel]
      - name: Measurement
        operations: [subscribe, read, unsubscribe]
      - name: GeneratorControl
        operations: [setPoint, raiseLower, accumulatorReset]
        description: "发电机控制能力"

# 能力类型定义
capability_types:
  - name: Control
    operations:
      - name: execute
        input_type: ControlCommand
        output_type: ControlResult
        description: "执行控制命令"
      - name: query
        input_type: QueryRequest
        output_type: QueryResult
        description: "查询控制状态"
      - name: cancel
        input_type: CancelRequest
        output_type: CancelResult
        description: "取消控制命令"

  - name: Measurement
    operations:
      - name: subscribe
        input_type: SubscriptionRequest
        output_type: SubscriptionResult
        description: "订阅测量数据"
      - name: read
        input_type: ReadRequest
        output_type: MeasurementValue
        description: "读取测量值"
      - name: unsubscribe
        input_type: UnsubscribeRequest
        output_type: UnsubscribeResult
        description: "取消订阅"

  - name: SwitchControl
    operations:
      - name: open
        input_type: SwitchCommand
        output_type: SwitchResult
        description: "打开开关"
      - name: close
        input_type: SwitchCommand
        output_type: SwitchResult
        description: "关闭开关"
      - name: queryState
        input_type: QueryStateRequest
        output_type: SwitchState
        description: "查询开关状态"

# 操作映射（将POSIX接口映射到能力操作）
operation_mapping:
  # ioctl 命令映射
  ioctl_commands:
    # Control 相关命令
    - ioctl_cmd: 0x1001
      capability: Control
      operation: execute
      message_type: AccumulatorResetMessage
    - ioctl_cmd: 0x1002
      capability: Control
      operation: execute
      message_type: CommandMessage
    - ioctl_cmd: 0x1003
      capability: Control
      operation: execute
      message_type: RaiseLowerCommandMessage
    - ioctl_cmd: 0x1004
      capability: Control
      operation: execute
      message_type: SetPointMessage
    
    # SwitchControl 相关命令
    - ioctl_cmd: 0x2001
      capability: SwitchControl
      operation: open
      message_type: SwitchCommand
    - ioctl_cmd: 0x2002
      capability: SwitchControl
      operation: close
      message_type: SwitchCommand
    - ioctl_cmd: 0x2003
      capability: SwitchControl
      operation: queryState
      message_type: QueryStateRequest
    
    # Measurement 相关命令
    - ioctl_cmd: 0x3001
      capability: Measurement
      operation: subscribe
      message_type: SubscriptionRequest
    - ioctl_cmd: 0x3002
      capability: Measurement
      operation: read
      message_type: ReadRequest
    - ioctl_cmd: 0x3003
      capability: Measurement
      operation: unsubscribe
      message_type: UnsubscribeRequest
