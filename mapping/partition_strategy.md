# åˆ†åŒºå­—æ®µè‡ªåŠ¨ç¡®å®šç­–ç•¥

## ğŸ“‹ æ¦‚è¿°

åˆ†åŒºå­—æ®µçš„è‡ªåŠ¨ç¡®å®šé‡‡ç”¨å¤šçº§ç­–ç•¥ï¼ŒæŒ‰ä¼˜å…ˆçº§ä¾æ¬¡å°è¯•ï¼Œç›´åˆ°æ‰¾åˆ°åˆé€‚çš„åˆ†åŒºå­—æ®µã€‚

## ğŸ¯ è‡ªåŠ¨ç¡®å®šç­–ç•¥ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ç­–ç•¥ 1: æ˜¾å¼é…ç½®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

ä½¿ç”¨ `mapping/rules.py` ä¸­çš„ `PARTITION_STRATEGY` é…ç½®ï¼š

```python
PARTITION_STRATEGY = {
    "Substation": ["region"],
    "VoltageLevel": ["substation_id"],
    "Breaker": ["voltage_level_id"],
    "Asset": ["criticality"],
    "Work": ["status"],
    "Meter": ["usage_point_id"],
    "UsagePoint": ["service_category"],
}
```

**ä¼˜ç‚¹**: ç²¾ç¡®æ§åˆ¶ï¼Œå¯é’ˆå¯¹æ¯ä¸ªå®ä½“ç±»å‹å®šåˆ¶  
**é€‚ç”¨**: å·²çŸ¥æœ€ä½³åˆ†åŒºç­–ç•¥çš„å®ä½“

### ç­–ç•¥ 2: å…³ç³»æ¨æ–­

æ ¹æ®å®ä½“å…³ç³»è‡ªåŠ¨æ¨æ–­ï¼š

- **`partOf` å…³ç³»**: å¦‚æœå®ä½“å±äºå¦ä¸€ä¸ªå®ä½“ï¼Œä½¿ç”¨çˆ¶å®ä½“çš„ ID ä½œä¸ºåˆ†åŒºå­—æ®µ
  - ä¾‹å¦‚ï¼š`VoltageLevel` æœ‰ `partOf -> Substation` å…³ç³»
  - è‡ªåŠ¨æ¨æ–­ï¼šåˆ†åŒºå­—æ®µ = `substation_id`

**ä¼˜ç‚¹**: ç¬¦åˆä¸šåŠ¡å±‚çº§å…³ç³»ï¼ŒæŸ¥è¯¢æ•ˆç‡é«˜  
**é€‚ç”¨**: æœ‰æ˜ç¡®å±‚çº§å…³ç³»çš„å®ä½“

### ç­–ç•¥ 3: æ¨¡å¼åŒ¹é…

æ ¹æ®å­—æ®µåæ¨¡å¼åŒ¹é…å¸¸è§åˆ†åŒºå­—æ®µï¼š

ä¼˜å…ˆçº§é¡ºåºï¼š
1. `region` - åœ°ç†åˆ†åŒº
2. `substation_id` - å˜ç”µç«™åˆ†åŒº
3. `voltage_level_id` - ç”µå‹ç­‰çº§åˆ†åŒº
4. `status` - çŠ¶æ€åˆ†åŒº
5. `criticality` - é‡è¦æ€§åˆ†åŒº
6. `service_category` - æœåŠ¡ç±»åˆ«åˆ†åŒº

**ä¼˜ç‚¹**: è¦†ç›–å¸¸è§åœºæ™¯  
**é€‚ç”¨**: ä½¿ç”¨æ ‡å‡†å‘½åè§„èŒƒçš„å®ä½“

### ç­–ç•¥ 4: å¤–é”®å­—æ®µ

æŸ¥æ‰¾æ‰€æœ‰ä»¥ `_id` ç»“å°¾çš„å¤–é”®å­—æ®µï¼š

- æ’é™¤ï¼š`entity_id`ï¼ˆä¸»é”®ï¼‰
- é€‰æ‹©ï¼šç¬¬ä¸€ä¸ªå¤–é”®å­—æ®µ

**ä¼˜ç‚¹**: å¤–é”®é€šå¸¸æœ‰è¾ƒå¥½çš„æ•°æ®åˆ†å¸ƒ  
**é€‚ç”¨**: æœ‰å¤–é”®å…³ç³»çš„å®ä½“

### ç­–ç•¥ 5: æšä¸¾å­—æ®µ

æŸ¥æ‰¾å¯èƒ½çš„æšä¸¾ç±»å‹å­—æ®µï¼š

- ç±»å‹ï¼š`STRING`
- æ’é™¤ï¼šä¸»é”®ã€åç§°ã€æè¿°ã€æ—¶é—´å­—æ®µ
- é€‰æ‹©ï¼šç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„å­—æ®µ

**ä¼˜ç‚¹**: æšä¸¾å­—æ®µé€šå¸¸æœ‰è¾ƒå¥½çš„åˆ†åŒºæ•ˆæœ  
**é€‚ç”¨**: æœ‰åˆ†ç±»/çŠ¶æ€å­—æ®µçš„å®ä½“

### ç­–ç•¥ 6: ä¸åˆ†åŒºï¼ˆé»˜è®¤ï¼‰

å¦‚æœä»¥ä¸Šç­–ç•¥éƒ½æ‰¾ä¸åˆ°åˆé€‚çš„å­—æ®µï¼Œè¿”å›ç©ºåˆ—è¡¨ï¼ˆä¸åˆ†åŒºï¼‰ã€‚

**ä¼˜ç‚¹**: é¿å…é”™è¯¯çš„åˆ†åŒºé€‰æ‹©  
**é€‚ç”¨**: æ²¡æœ‰æ˜æ˜¾åˆ†åŒºç‰¹å¾çš„å®ä½“

## ğŸ“Š ç¤ºä¾‹

### ç¤ºä¾‹ 1: Substationï¼ˆå˜ç”µç«™ï¼‰

```yaml
å®ä½“: Substation
å±æ€§: [mRID, name, description, region]
å…³ç³»: [contains -> VoltageLevel]
```

**è‡ªåŠ¨ç¡®å®šè¿‡ç¨‹**:
1. âœ… ç­–ç•¥ 1: é…ç½®ä¸­æœ‰ `"Substation": ["region"]` â†’ **ä½¿ç”¨ `region`**

### ç¤ºä¾‹ 2: VoltageLevelï¼ˆç”µå‹ç­‰çº§ï¼‰

```yaml
å®ä½“: VoltageLevel
å±æ€§: [mRID, nominalVoltage]
å…³ç³»: [partOf -> Substation]
```

**è‡ªåŠ¨ç¡®å®šè¿‡ç¨‹**:
1. âœ… ç­–ç•¥ 1: é…ç½®ä¸­æœ‰ `"VoltageLevel": ["substation_id"]` â†’ **ä½¿ç”¨ `substation_id`**
   - æ³¨æ„ï¼š`substation_id` ä¼šæ ¹æ® `partOf` å…³ç³»è‡ªåŠ¨æ·»åŠ 

### ç¤ºä¾‹ 3: æ–°å®ä½“ï¼ˆæ— é…ç½®ï¼‰

```yaml
å®ä½“: NewEntity
å±æ€§: [mRID, name, parent_id, status]
å…³ç³»: [partOf -> ParentEntity]
```

**è‡ªåŠ¨ç¡®å®šè¿‡ç¨‹**:
1. âŒ ç­–ç•¥ 1: æ— é…ç½®
2. âœ… ç­–ç•¥ 2: æœ‰ `partOf -> ParentEntity` å…³ç³» â†’ **ä½¿ç”¨ `parent_entity_id`**

### ç¤ºä¾‹ 4: ç®€å•å®ä½“ï¼ˆæ— å…³ç³»ï¼‰

```yaml
å®ä½“: SimpleEntity
å±æ€§: [mRID, name, category]
å…³ç³»: []
```

**è‡ªåŠ¨ç¡®å®šè¿‡ç¨‹**:
1. âŒ ç­–ç•¥ 1: æ— é…ç½®
2. âŒ ç­–ç•¥ 2: æ—  `partOf` å…³ç³»
3. âŒ ç­–ç•¥ 3: æ— åŒ¹é…æ¨¡å¼
4. âŒ ç­–ç•¥ 4: æ— å¤–é”®å­—æ®µ
5. âœ… ç­–ç•¥ 5: `category` æ˜¯æšä¸¾å­—æ®µ â†’ **ä½¿ç”¨ `category`**

## ğŸ”§ è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥

### æ–¹æ³• 1: ä¿®æ”¹é…ç½®ï¼ˆæ¨èï¼‰

ç¼–è¾‘ `mapping/rules.py`:

```python
PARTITION_STRATEGY = {
    "YourEntity": ["your_partition_field"],
    # ...
}
```

### æ–¹æ³• 2: æ‰©å±•æ¨¡å¼åŒ¹é…

åœ¨ `_auto_determine_partition_fields` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„æ¨¡å¼ï¼š

```python
priority_patterns = [
    "region",
    "your_custom_field",  # æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
    # ...
]
```

### æ–¹æ³• 3: æ·»åŠ æ–°çš„æ¨æ–­è§„åˆ™

åœ¨ `_auto_determine_partition_fields` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„ç­–ç•¥ï¼š

```python
# ç­–ç•¥ X: ä½ çš„è‡ªå®šä¹‰è§„åˆ™
if your_condition:
    partition_fields = [your_field]
    return partition_fields
```

## ğŸ“ˆ åˆ†åŒºå­—æ®µé€‰æ‹©åŸåˆ™

### å¥½çš„åˆ†åŒºå­—æ®µç‰¹å¾

1. **åŸºæ•°é€‚ä¸­**: æ—¢ä¸èƒ½å¤ªå°‘ï¼ˆå¦‚åªæœ‰ 2-3 ä¸ªå€¼ï¼‰ï¼Œä¹Ÿä¸èƒ½å¤ªå¤šï¼ˆæ¥è¿‘å”¯ä¸€å€¼ï¼‰
   - æ¨èï¼š10-1000 ä¸ªä¸åŒçš„å€¼

2. **æŸ¥è¯¢æ¨¡å¼åŒ¹é…**: ç»å¸¸ç”¨äº WHERE æ¡ä»¶çš„å­—æ®µ
   - ä¾‹å¦‚ï¼šæŒ‰ `region` æŸ¥è¯¢ã€æŒ‰ `substation_id` æŸ¥è¯¢

3. **æ•°æ®åˆ†å¸ƒå‡åŒ€**: å„åˆ†åŒºæ•°æ®é‡ç›¸å¯¹å‡è¡¡
   - é¿å…ï¼šæŸä¸ªåˆ†åŒºæ•°æ®é‡è¿‡å¤§

4. **ä¸šåŠ¡æ„ä¹‰**: ç¬¦åˆä¸šåŠ¡æŸ¥è¯¢ä¹ æƒ¯
   - ä¾‹å¦‚ï¼šæŒ‰åœ°ç†åŒºåŸŸã€æŒ‰ç»„ç»‡å±‚çº§

### é¿å…çš„åˆ†åŒºå­—æ®µ

1. **é«˜åŸºæ•°å­—æ®µ**: æ¥è¿‘å”¯ä¸€å€¼çš„å­—æ®µï¼ˆå¦‚ `entity_id`ï¼‰
2. **ä½åŸºæ•°å­—æ®µ**: åªæœ‰å¾ˆå°‘å€¼çš„å­—æ®µï¼ˆå¦‚å¸ƒå°”å€¼ï¼‰
3. **æ—¶é—´å­—æ®µ**: é€šå¸¸ä¸é€‚åˆç›´æ¥åˆ†åŒºï¼ˆé™¤éæ˜¯æ—¥æœŸèŒƒå›´ï¼‰
4. **é¢‘ç¹æ›´æ–°çš„å­—æ®µ**: ä¼šå¯¼è‡´é¢‘ç¹çš„æ•°æ®é‡ç»„

## ğŸ¨ å¯è§†åŒ–åˆ†åŒºç­–ç•¥

åœ¨è¯­ä¹‰æ¨¡å‹ç®¡ç†ç•Œé¢ï¼ˆ`/ontology.html`ï¼‰ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªå®ä½“çš„åˆ†åŒºå­—æ®µï¼š

- æ˜¾ç¤ºåœ¨å®ä½“è¯¦æƒ…é¡µçš„"Iceberg è¡¨ç»“æ„"éƒ¨åˆ†
- æ ¼å¼ï¼š`åˆ†åŒºå­—æ®µ: region, substation_id`

## ğŸ” è°ƒè¯•åˆ†åŒºå­—æ®µé€‰æ‹©

### æŸ¥çœ‹è‡ªåŠ¨ç¡®å®šçš„æ—¥å¿—

å¯ä»¥åœ¨ `mapper.py` ä¸­æ·»åŠ æ—¥å¿—ï¼š

```python
import logging
logger = logging.getLogger(__name__)

def _auto_determine_partition_fields(self, entity, columns):
    # ...
    logger.info(f"Entity {entity.name}: Using partition fields {partition_fields} (strategy: {strategy_used})")
```

### æµ‹è¯•åˆ†åŒºå­—æ®µé€‰æ‹©

```python
from mapping.mapper import EntityMapper
from ontology.parser import get_semantic_model

model = get_semantic_model()
mapper = EntityMapper(model)

entity = model.get_entity("YourEntity")
schema = mapper.map_entity_to_table(entity)

print(f"Partition fields: {schema.partition_fields}")
```

## ğŸ“ æ€»ç»“

è‡ªåŠ¨åˆ†åŒºå­—æ®µç¡®å®šé‡‡ç”¨**å¤šçº§ç­–ç•¥**ï¼Œç¡®ä¿ï¼š
- âœ… ä¼˜å…ˆä½¿ç”¨æ˜¾å¼é…ç½®ï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰
- âœ… æ™ºèƒ½æ¨æ–­å…³ç³»ï¼ˆç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼‰
- âœ… æ¨¡å¼åŒ¹é…å¸¸è§åœºæ™¯ï¼ˆè¦†ç›–æ ‡å‡†æƒ…å†µï¼‰
- âœ… é™çº§åˆ°å®‰å…¨é»˜è®¤å€¼ï¼ˆé¿å…é”™è¯¯é€‰æ‹©ï¼‰

è¿™æ ·çš„è®¾è®¡æ—¢ä¿è¯äº†çµæ´»æ€§ï¼Œåˆæä¾›äº†æ™ºèƒ½çš„é»˜è®¤è¡Œä¸ºã€‚

