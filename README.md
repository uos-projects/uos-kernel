# ç”µåŠ›æ•°å­—å­ªç”Ÿå¹³å° - ç³»ç»Ÿæ¶æ„ä¸ä»£ç è¯´æ˜

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäº Apache Iceberg æ„å»ºçš„ç”µåŠ›è¡Œä¸šæ•°å­—å­ªç”Ÿå¹³å°ï¼Œå€Ÿé‰´ Palantir Ontology çš„è®¾è®¡ç†å¿µï¼Œä½¿ç”¨ CIM (Common Information Model) æ ‡å‡†è¿›è¡Œè¯­ä¹‰å»ºæ¨¡ï¼Œæ”¯æŒå®ä½“å’Œå…³ç³»çš„æ—¶é—´æ—…è¡ŒæŸ¥è¯¢ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯å±‚ (Web UI)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ æ‹“æ‰‘è§†å›¾     â”‚  â”‚ å®ä½“/å…³ç³»åˆ—è¡¨â”‚  â”‚ Snapshotåˆ—è¡¨ â”‚      â”‚
â”‚  â”‚ (D3.js)     â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                â”‚                â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                â”‚                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP/REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API æœåŠ¡å±‚ (FastAPI)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  /api/view      - æ—¶é—´æ—…è¡ŒæŸ¥è¯¢                     â”‚   â”‚
â”‚  â”‚  /api/snapshots - è·å–æ‰€æœ‰è¡¨çš„ snapshots          â”‚   â”‚
â”‚  â”‚  /api/health    - å¥åº·æ£€æŸ¥                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ PySpark SQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®è®¡ç®—å±‚ (Apache Spark)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SparkSession with Iceberg Extensions              â”‚   â”‚
â”‚  â”‚  - æ—¶é—´æ—…è¡ŒæŸ¥è¯¢ (VERSION AS OF / TIMESTAMP AS OF)  â”‚   â”‚
â”‚  â”‚  - ä¸šåŠ¡æ—¶é—´æŸ¥è¯¢ (valid_from/valid_to)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nessie Catalogâ”‚  â”‚  Apache Iceberg â”‚  â”‚  MinIO (S3)    â”‚
â”‚  (Git-like)    â”‚  â”‚  (Table Format) â”‚  â”‚  (Object Store)â”‚
â”‚  - ç‰ˆæœ¬ç®¡ç†    â”‚  â”‚  - ACIDäº‹åŠ¡     â”‚  â”‚  - æ•°æ®å­˜å‚¨    â”‚
â”‚  - åˆ†æ”¯/æ ‡ç­¾   â”‚  â”‚  - Time Travel  â”‚  â”‚  - Parquetæ–‡ä»¶ â”‚
â”‚                â”‚  â”‚  - Schemaæ¼”è¿›   â”‚  â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

#### åç«¯æŠ€æœ¯æ ˆ
- **FastAPI**: Python Web æ¡†æ¶ï¼Œæä¾› REST API
- **PySpark**: Spark Python APIï¼Œç”¨äºæ•°æ®æŸ¥è¯¢å’Œå¤„ç†
- **Apache Iceberg**: æ•°æ®æ¹–è¡¨æ ¼å¼ï¼Œæ”¯æŒ ACID äº‹åŠ¡å’Œæ—¶é—´æ—…è¡Œ
- **Nessie**: Git-like æ•°æ®ç›®å½•ï¼Œæä¾›ç‰ˆæœ¬ç®¡ç†å’Œåˆ†æ”¯åŠŸèƒ½
- **MinIO**: S3 å…¼å®¹çš„å¯¹è±¡å­˜å‚¨ï¼Œç”¨äºå­˜å‚¨ Iceberg æ•°æ®æ–‡ä»¶

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **åŸç”Ÿ JavaScript**: æ— æ¡†æ¶ä¾èµ–
- **D3.js**: æ•°æ®å¯è§†åŒ–ï¼Œç”¨äºæ‹“æ‰‘å›¾æ¸²æŸ“
- **HTML5/CSS3**: å“åº”å¼å¸ƒå±€

#### åŸºç¡€è®¾æ–½
- **Docker Compose**: å®¹å™¨ç¼–æ’
- **Spark**: åˆ†å¸ƒå¼è®¡ç®—å¼•æ“

## ğŸ“ é¡¹ç›®ç»“æ„

```
uos-kernel/
â”œâ”€â”€ infra/                          # åŸºç¡€è®¾æ–½é…ç½®
â”‚   â”œâ”€â”€ docker-compose.yml         # Docker Compose é…ç½®
â”‚   â””â”€â”€ USAGE.txt                  # ä½¿ç”¨è¯´æ˜
â”‚
â”œâ”€â”€ ontology/                       # è¯­ä¹‰æ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ cim_scope.yaml             # CIM è¯­ä¹‰èŒƒå›´å®šä¹‰
â”‚
â”œâ”€â”€ scripts/                        # æ•°æ®è„šæœ¬
â”‚   â”œâ”€â”€ bootstrap_iceberg.py       # åˆå§‹åŒ– Iceberg è¡¨å’Œåˆå§‹æ•°æ®
â”‚   â”œâ”€â”€ generate_timeline_data.py  # ç”Ÿæˆæ—¶é—´çº¿æ•°æ®ï¼ˆå¤šæ—¶é—´ç‚¹ï¼‰
â”‚   â””â”€â”€ time_travel_demo.py        # æ—¶é—´æ—…è¡ŒæŸ¥è¯¢ç¤ºä¾‹
â”‚
â”œâ”€â”€ server/                         # åç«¯æœåŠ¡
â”‚   â””â”€â”€ app.py                     # FastAPI åº”ç”¨ä¸»æ–‡ä»¶
â”‚
â”œâ”€â”€ web/                            # å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ index.html                 # ä¸»é¡µé¢
â”‚   â”œâ”€â”€ app.js                     # å‰ç«¯é€»è¾‘
â”‚   â”œâ”€â”€ styles.css                 # æ ·å¼æ–‡ä»¶
â”‚   â””â”€â”€ d3.min.js                  # D3.js åº“ï¼ˆæœ¬åœ°ï¼‰
â”‚
â”œâ”€â”€ Makefile                        # æ„å»ºè„šæœ¬
â”œâ”€â”€ requirements.txt               # Python ä¾èµ–
â””â”€â”€ README.md                      # æœ¬æ–‡æ¡£
```

## ğŸ”‘ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. è¯­ä¹‰æ¨¡å‹å±‚ (`ontology/cim_scope.yaml`)

å®šä¹‰äº†åŸºäº CIM æ ‡å‡†çš„ç²¾ç®€è¯­ä¹‰æ¨¡å‹ï¼ŒåŒ…å«ï¼š

**å®ä½“ç±»å‹ï¼ˆ4ä¸ªåŒ…ï¼Œ13ç§å®ä½“ï¼‰**:
- **Topology åŒ…**: Substationï¼ˆå˜ç”µç«™ï¼‰ã€VoltageLevelï¼ˆç”µå‹ç­‰çº§ï¼‰ã€ConnectivityNodeã€Terminal
- **Wires & Equipment åŒ…**: PowerTransformerï¼ˆç”µåŠ›å˜å‹å™¨ï¼‰ã€ACLineSegmentã€Breakerï¼ˆæ–­è·¯å™¨ï¼‰
- **Assets & Maintenance åŒ…**: Assetï¼ˆèµ„äº§ï¼‰ã€Workï¼ˆå·¥ä½œå•ï¼‰ã€WorkTask
- **Metering & Market åŒ…**: UsagePointï¼ˆç”¨ç”µç‚¹ï¼‰ã€Meterï¼ˆç”µè¡¨ï¼‰ã€MeterReading

**å…³ç³»ç±»å‹**:
- æ‹“æ‰‘å…³ç³»: `contains`ï¼ˆåŒ…å«ï¼‰ã€`partOf`ï¼ˆå±äºï¼‰ã€`locatedIn`ï¼ˆä½äºï¼‰
- èµ„äº§å…³ç³»: `realises`ï¼ˆå®ç°ï¼‰ã€`targets`ï¼ˆç›®æ ‡ï¼‰
- è®¡é‡å…³ç³»: `measuredBy`ï¼ˆæµ‹é‡ï¼‰

### 2. æ•°æ®å­˜å‚¨å±‚

#### Iceberg è¡¨ç»“æ„

**å®ä½“è¡¨** (æŒ‰å‘½åç©ºé—´ç»„ç»‡):
```
ontology.grid.substation          # å˜ç”µç«™è¡¨
ontology.grid.voltage_level        # ç”µå‹ç­‰çº§è¡¨
ontology.grid.power_transformer    # ç”µåŠ›å˜å‹å™¨è¡¨
ontology.grid.breaker              # æ–­è·¯å™¨è¡¨
ontology.assets.asset              # èµ„äº§è¡¨
ontology.assets.work               # å·¥ä½œå•è¡¨
ontology.metering.meter            # ç”µè¡¨è¡¨
ontology.metering.usage_point      # ç”¨ç”µç‚¹è¡¨
```

**å…³ç³»è¡¨**:
```
ontology.relations.substation_voltage_level    # å˜ç”µç«™-ç”µå‹ç­‰çº§å…³ç³»
ontology.relations.transformer_substation      # å˜å‹å™¨-å˜ç”µç«™å…³ç³»
ontology.relations.breaker_voltage_level       # æ–­è·¯å™¨-ç”µå‹ç­‰çº§å…³ç³»
ontology.relations.asset_resource              # èµ„äº§-èµ„æºå…³ç³»
ontology.relations.work_resource               # å·¥ä½œ-èµ„æºå…³ç³»
ontology.relations.meter_usage_point           # ç”µè¡¨-ç”¨ç”µç‚¹å…³ç³»
```

**é€šç”¨å­—æ®µ**:
- `valid_from`: ä¸šåŠ¡ç”Ÿæ•ˆæ—¶é—´ï¼ˆTIMESTAMPï¼‰
- `valid_to`: ä¸šåŠ¡å¤±æ•ˆæ—¶é—´ï¼ˆTIMESTAMPï¼‰
- `op_type`: æ“ä½œç±»å‹ï¼ˆinsert/update/deleteï¼‰
- `ingestion_ts`: æ•°æ®æ‘„å…¥æ—¶é—´ï¼ˆTIMESTAMPï¼‰

#### æ—¶é—´æ—…è¡Œæœºåˆ¶

ç³»ç»Ÿæ”¯æŒä¸¤ç§æ—¶é—´æ—…è¡Œæ–¹å¼ï¼š

1. **æŠ€æœ¯æ—¶é—´æ—…è¡Œ**ï¼ˆIceberg åŸç”Ÿï¼‰:
   - `VERSION AS OF <snapshot_id>`: åŸºäº snapshot ID
   - `TIMESTAMP AS OF <timestamp>`: åŸºäºæäº¤æ—¶é—´æˆ³

2. **ä¸šåŠ¡æ—¶é—´æ—…è¡Œ**ï¼ˆåº”ç”¨å±‚ï¼‰:
   - `WHERE '<time>' BETWEEN valid_from AND valid_to`: åŸºäºä¸šåŠ¡ç”Ÿæ•ˆæ—¶é—´

### 3. API æœåŠ¡å±‚ (`server/app.py`)

#### æ ¸å¿ƒåŠŸèƒ½

**SparkSession ç®¡ç†**:
```python
def build_spark() -> SparkSession
```
- é…ç½® Iceberg Catalogï¼ˆNessieï¼‰
- é…ç½® S3 æ–‡ä»¶ç³»ç»Ÿï¼ˆMinIOï¼‰
- å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…å¯åŠ¨é˜»å¡

**API ç«¯ç‚¹**:

1. **`GET /api/view`**: æ—¶é—´æ—…è¡ŒæŸ¥è¯¢
   - å‚æ•°:
     - `mode`: `biz`ï¼ˆä¸šåŠ¡æ—¶é—´ï¼‰| `snapshot`ï¼ˆsnapshot IDï¼‰| `timestamp`ï¼ˆæ—¶é—´æˆ³ï¼‰
     - `value`: å¯¹åº”çš„æ—¶é—´å€¼
   - è¿”å›: å®ä½“åˆ—è¡¨å’Œå…³ç³»åˆ—è¡¨

2. **`GET /api/snapshots`**: è·å–æ‰€æœ‰è¡¨çš„ snapshots
   - å‚æ•°: `table`ï¼ˆå¯é€‰ï¼Œä¸æŒ‡å®šåˆ™è¿”å›æ‰€æœ‰è¡¨ï¼‰
   - è¿”å›: æŒ‰æ—¶é—´æ’åºçš„æ‰€æœ‰ snapshots

3. **`GET /api/health`**: å¥åº·æ£€æŸ¥

**æŸ¥è¯¢é€»è¾‘**:
- æ”¯æŒæŸ¥è¯¢æ‰€æœ‰å®ä½“ç±»å‹å’Œå…³ç³»ç±»å‹
- è‡ªåŠ¨å¤„ç†è¡¨ä¸å­˜åœ¨çš„æƒ…å†µ
- ä½¿ç”¨ Spark SQL è¿›è¡Œæ—¶é—´æ—…è¡ŒæŸ¥è¯¢

### 4. å‰ç«¯å±‚ (`web/`)

#### ä¸»è¦åŠŸèƒ½

**æ—¶é—´è½´æ§ä»¶**:
- èŒƒå›´: 2025-01-01 è‡³ 2025-05-31ï¼ˆ150å¤©ï¼‰
- æ˜¾ç¤ºæ‰€æœ‰ snapshots çš„æ—¶é—´ç‚¹æ ‡è®°
- ç‚¹å‡»æ ‡è®°ç‚¹å¿«é€Ÿè·³è½¬

**æ‹“æ‰‘è§†å›¾** (D3.js):
- åŠ›å¯¼å‘å›¾å¸ƒå±€
- èŠ‚ç‚¹æ‹–æ‹½åŠŸèƒ½
- å®ä½“åç§°æ˜¾ç¤ºï¼ˆä¸­æ–‡ï¼‰
- å…³ç³»ç±»å‹æ ‡ç­¾æ˜¾ç¤ºåœ¨è¿çº¿ä¸Šï¼ˆä¸­æ–‡ï¼‰

**æ•°æ®å±•ç¤º**:
- å®ä½“åˆ—è¡¨ï¼šæ˜¾ç¤ºæ‰€æœ‰å®ä½“åŠå…¶å±æ€§
- å…³ç³»åˆ—è¡¨ï¼šæ˜¾ç¤ºæ‰€æœ‰å…³ç³»åŠå…¶å±æ€§
- Snapshot åˆ—è¡¨ï¼šæ˜¾ç¤ºæ‰€æœ‰è¡¨çš„ snapshots

**ä¸­æ–‡æ˜ å°„**:
- å®ä½“ç±»å‹æ˜ å°„ï¼š`substation` â†’ "å˜ç”µç«™"
- å…³ç³»ç±»å‹æ˜ å°„ï¼š`contains` â†’ "åŒ…å«"

#### å…³é”®ä»£ç 

**æ—¶é—´è½´æ ‡è®°ç‚¹** (`app.js`):
```javascript
function updateTimelineMarkers(snapshots)
```
- ä» snapshots æå–æ—¶é—´ç‚¹
- åœ¨æ—¶é—´è½´ä¸Šåˆ›å»ºå¯ç‚¹å‡»çš„æ ‡è®°ç‚¹

**æ‹“æ‰‘å›¾æ¸²æŸ“** (`app.js`):
```javascript
function renderGraph(entities, relations)
```
- æ„å»ºèŠ‚ç‚¹å’Œè¾¹çš„æ•°æ®ç»“æ„
- ä½¿ç”¨ D3.js force simulation å¸ƒå±€
- æ·»åŠ è¿çº¿æ ‡ç­¾æ˜¾ç¤ºå…³ç³»ç±»å‹

### 5. æ•°æ®è„šæœ¬

#### `scripts/bootstrap_iceberg.py`
- åˆå§‹åŒ– Iceberg ç¯å¢ƒ
- åˆ›å»ºå‘½åç©ºé—´å’Œè¡¨ç»“æ„
- å†™å…¥åˆå§‹ç¤ºä¾‹æ•°æ®

#### `scripts/generate_timeline_data.py`
- ç”Ÿæˆå¤šä¸ªæ—¶é—´ç‚¹çš„æ•°æ®
- æ¨¡æ‹Ÿæ—¶é—´æ¼”è¿›åœºæ™¯
- åˆ›å»ºå¤šä¸ª snapshots
- æ˜¾ç¤ºæ‰€æœ‰è¡¨çš„ snapshots ç»Ÿè®¡

#### `scripts/time_travel_demo.py`
- æ¼”ç¤ºæ—¶é—´æ—…è¡ŒæŸ¥è¯¢
- å±•ç¤ºä¸åŒæ—¶é—´ç‚¹çš„æ•°æ®å·®å¼‚

## ğŸ”„ æ•°æ®æµ

### æ•°æ®å†™å…¥æµç¨‹

```
1. æ•°æ®ç”Ÿæˆè„šæœ¬ (generate_timeline_data.py)
   â†“
2. PySpark DataFrame
   â†“
3. Iceberg Table (writeTo().append())
   â†“
4. åˆ›å»ºæ–°çš„ Snapshot
   â†“
5. å†™å…¥ Parquet æ–‡ä»¶åˆ° MinIO
   â†“
6. æ›´æ–° Nessie Catalog å…ƒæ•°æ®
```

### æ•°æ®æŸ¥è¯¢æµç¨‹

```
1. å‰ç«¯è¯·æ±‚ (/api/view?mode=biz&value=2025-01-15)
   â†“
2. FastAPI è·¯ç”±å¤„ç†
   â†“
3. æ„å»º Spark SQL æŸ¥è¯¢
   - ä¸šåŠ¡æ—¶é—´: WHERE '2025-01-15' BETWEEN valid_from AND valid_to
   - Snapshot: VERSION AS OF <snapshot_id>
   - Timestamp: TIMESTAMP AS OF '<timestamp>'
   â†“
4. Spark æ‰§è¡ŒæŸ¥è¯¢
   â†“
5. Iceberg è¯»å–å¯¹åº”ç‰ˆæœ¬çš„æ•°æ®
   â†“
6. è¿”å› JSON ç»“æœ
   â†“
7. å‰ç«¯æ¸²æŸ“ï¼ˆæ‹“æ‰‘å›¾ã€åˆ—è¡¨ï¼‰
```

## ğŸš€ éƒ¨ç½²ä¸è¿è¡Œ

### å¯åŠ¨åŸºç¡€è®¾æ–½

```bash
make infra-up
# æˆ–
docker compose -f infra/docker-compose.yml up -d
```

å¯åŠ¨çš„æœåŠ¡:
- MinIO: http://localhost:19000 (API), http://localhost:19001 (Console)
- Nessie: http://localhost:19120
- Spark: å®¹å™¨è¿è¡Œï¼ˆç”¨äºæ•°æ®è„šæœ¬ï¼‰

### åˆå§‹åŒ–æ•°æ®

```bash
# åˆ›å»º MinIO bucket
aws --endpoint-url http://localhost:19000 s3api create-bucket --bucket iceberg

# åˆå§‹åŒ–è¡¨å’Œåˆå§‹æ•°æ®
python scripts/bootstrap_iceberg.py

# ç”Ÿæˆæ—¶é—´çº¿æ•°æ®
python scripts/generate_timeline_data.py
```

### å¯åŠ¨åç«¯æœåŠ¡

```bash
uvicorn server.app:app --host 0.0.0.0 --port 8000
```

### è®¿é—®å‰ç«¯

æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost:8000

## ğŸ“Š æ•°æ®æ¨¡å‹ç¤ºä¾‹

### å®ä½“ç¤ºä¾‹

```json
{
  "entity_id": "SS-001",
  "name": "åŒ—åŸå˜ç”µç«™",
  "region": "North",
  "nominal_voltage_kv": 220.0,
  "valid_from": "2025-01-01T00:00:00",
  "valid_to": "9999-12-31T00:00:00",
  "op_type": "insert",
  "ingestion_ts": "2025-11-20T12:18:31",
  "entity_type": "substation"
}
```

### å…³ç³»ç¤ºä¾‹

```json
{
  "rel_id": "REL-SS001-VL001",
  "source_id": "SS-001",
  "target_id": "VL-001",
  "relation_type": "contains",
  "valid_from": "2025-01-01T00:00:00",
  "valid_to": "9999-12-31T00:00:00",
  "op_type": "insert",
  "ingestion_ts": "2025-11-20T12:18:31"
}
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

1. **æ—¶é—´æ—…è¡ŒæŸ¥è¯¢**: æ”¯æŒæŠ€æœ¯æ—¶é—´å’Œä¸šåŠ¡æ—¶é—´ä¸¤ç§æ–¹å¼
2. **ç‰ˆæœ¬ç®¡ç†**: åŸºäº Nessie çš„ Git-like ç‰ˆæœ¬æ§åˆ¶
3. **è¯­ä¹‰å»ºæ¨¡**: åŸºäº CIM æ ‡å‡†çš„ç”µåŠ›è¡Œä¸šè¯­ä¹‰æ¨¡å‹
4. **å¯è§†åŒ–**: D3.js æ‹“æ‰‘å›¾ï¼Œæ”¯æŒäº¤äº’å¼æ¢ç´¢
5. **ä¸­æ–‡æ”¯æŒ**: å®ä½“å’Œå…³ç³»ç±»å‹çš„ä¸­æ–‡æ˜¾ç¤º
6. **å“åº”å¼è®¾è®¡**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

- `AWS_REGION`: AWS åŒºåŸŸï¼ˆé»˜è®¤: us-east-1ï¼‰
- `AWS_ACCESS_KEY_ID`: MinIO è®¿é—®å¯†é’¥ï¼ˆé»˜è®¤: icebergï¼‰
- `AWS_SECRET_ACCESS_KEY`: MinIO å¯†é’¥ï¼ˆé»˜è®¤: iceberg_passwordï¼‰

### ç«¯å£é…ç½®

- `8000`: FastAPI åç«¯æœåŠ¡
- `19000`: MinIO API
- `19001`: MinIO Console
- `19120`: Nessie Catalog

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„å®ä½“ç±»å‹

1. åœ¨ `ontology/cim_scope.yaml` ä¸­å®šä¹‰å®ä½“
2. åœ¨ `scripts/generate_timeline_data.py` ä¸­åˆ›å»ºè¡¨ç»“æ„
3. åœ¨ `server/app.py` çš„ `ENTITY_QUERIES` ä¸­æ·»åŠ æŸ¥è¯¢
4. åœ¨å‰ç«¯ `app.js` çš„ `entityTypeMap` ä¸­æ·»åŠ ä¸­æ–‡æ˜ å°„

### æ·»åŠ æ–°çš„å…³ç³»ç±»å‹

1. åœ¨ `ontology/cim_scope.yaml` ä¸­å®šä¹‰å…³ç³»
2. åˆ›å»ºå¯¹åº”çš„å…³ç³»è¡¨
3. åœ¨ `server/app.py` çš„ `RELATION_QUERIES` ä¸­æ·»åŠ æŸ¥è¯¢
4. åœ¨å‰ç«¯ `app.js` çš„ `relationTypeMap` ä¸­æ·»åŠ ä¸­æ–‡æ˜ å°„

## ğŸ› å·²çŸ¥é—®é¢˜ä¸é™åˆ¶

1. **æ•°æ®é‡å¤**: ç”±äºä½¿ç”¨ `valid_to=9999-12-31`ï¼ŒæŸ¥è¯¢æ—¶ä¼šè¿”å›æ‰€æœ‰å†å²ç‰ˆæœ¬çš„æ•°æ®
2. **æ€§èƒ½**: SparkSession åˆå§‹åŒ–è¾ƒæ…¢ï¼Œä½¿ç”¨å»¶è¿ŸåŠ è½½ä¼˜åŒ–
3. **æµè§ˆå™¨å…¼å®¹**: D3.js éœ€è¦ç°ä»£æµè§ˆå™¨æ”¯æŒ

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

1. **æ•°æ®å»é‡**: å®ç°åŸºäº `ingestion_ts` çš„æ•°æ®å»é‡é€»è¾‘
2. **æ€§èƒ½ä¼˜åŒ–**: æ·»åŠ ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘ Spark æŸ¥è¯¢æ¬¡æ•°
3. **æ›´å¤šå¯è§†åŒ–**: æ·»åŠ æ—¶é—´çº¿è§†å›¾ã€å…³ç³»å›¾ç­›é€‰
4. **æ•°æ®å¯¼å…¥**: æ”¯æŒä»å¤–éƒ¨ç³»ç»Ÿå¯¼å…¥ CIM æ•°æ®
5. **æƒé™æ§åˆ¶**: æ·»åŠ ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†

## ğŸ“š å‚è€ƒèµ„æ–™

- [Apache Iceberg æ–‡æ¡£](https://iceberg.apache.org/)
- [Nessie æ–‡æ¡£](https://projectnessie.org/)
- [CIM æ ‡å‡†](https://www.iec.ch/)
- [D3.js æ–‡æ¡£](https://d3js.org/)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)

